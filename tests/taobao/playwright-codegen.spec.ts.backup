import { test, expect, devices } from '@playwright/test';
import { resolve } from 'dns';
import { snapshot } from 'node:test';
import * as readline from 'readline';


test.use({
    ...devices['iPhone 13'],
});


async function waitForVerificationCode(): Promise<string> {
    return new Promise((resolve) => {
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });
        rl.question('è¯·è¾“å…¥éªŒè¯ç ', (code) => {
            rl.close;
            resolve(code.trim());
        });
    });
}


async function waitForManualOperation(message: string = 'è¯·å®Œæˆæ“ä½œ'): Promise<void> {
    return new Promise((resolve) => {
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });

        console.log(`\nğŸ›‘ ${message}`);
        console.log('   å®ŒæˆåæŒ‰ Enter é”®ç»§ç»­...');

        rl.question('', () => {
            rl.close();
            resolve();
        });
    })
}


async function clickVerificationCodeButton(page) {
    console.log('ğŸ”„ å°è¯•ç‚¹å‡»è·å–éªŒè¯ç æŒ‰é’®...');
    
    // æ–¹æ³•1ï¼šæ­£å¸¸çš„ Playwright ç‚¹å‡»ï¼ˆé¦–é€‰ï¼‰
    try {
        const button = page.locator('iframe').contentFrame().getByRole('button', { name: 'è·å–éªŒè¯ç ' });
        await button.waitFor({ state: 'visible', timeout: 5000 });
        await button.click();
        console.log('âœ… æ–¹æ³•1ï¼šæ­£å¸¸ç‚¹å‡»æˆåŠŸ');
        return true;
    } catch (error) {
        console.log('âš ï¸ æ–¹æ³•1å¤±è´¥:', error.message);
    }
    try {
        const button = page.locator('iframe').contentFrame().getByText('è·å–éªŒè¯ç ');
        await button.click();
        console.log('âœ… æ–¹æ³•2ï¼šæ–‡æœ¬å®šä½ç‚¹å‡»æˆåŠŸ');
        return true;
    } catch (error) {
        console.log('âš ï¸ æ–¹æ³•2å¤±è´¥:', error.message);
    }
    
    // æ–¹æ³•3ï¼šä½¿ç”¨ JavaScript ç‚¹å‡»
    try {
        const clicked = await page.evaluate(() => {
            const iframe = document.querySelector('iframe');
            if (!iframe) return false;
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const buttons = iframeDoc.querySelectorAll('button, div[role="button"]');
            
            for (const button of buttons) {
                if (button.textContent?.includes('è·å–éªŒè¯ç ') || 
                    button.getAttribute('name')?.includes('éªŒè¯ç ')) {
                    button.click();
                    return true;
                }
            }
            return false;
        });
        
        if (clicked) {
            console.log('âœ… æ–¹æ³•3ï¼šJavaScriptç‚¹å‡»æˆåŠŸ');
            return true;
        }
    } catch (error) {
        console.log('âš ï¸ æ–¹æ³•3å¤±è´¥:', error.message);
    }
    
    console.log('âŒ æ‰€æœ‰ç‚¹å‡»æ–¹æ³•éƒ½å¤±è´¥äº†');
    return false;
}
    const clicked = await clickVerificationCodeButton(page);

    if (clicked) {
        // ç­‰å¾…çŸ­ä¿¡å‘é€ï¼ˆç»™ä¸€äº›æ—¶é—´ï¼‰
        await page.waitForTimeout(2000);
        
        // æ£€æŸ¥é¡µé¢çŠ¶æ€
        const currentUrl = page.url();
        console.log('ğŸ“‹ å½“å‰URL:', currentUrl);
        
        if (currentUrl.includes('blank') || !currentUrl.includes('taobao.com')) {
            console.log('âš ï¸ é¡µé¢è·³è½¬åˆ°éé¢„æœŸåœ°å€');
            await page.screenshot({ path: 'unexpected-navigation.png' });
            
            // å°è¯•å›åˆ°æ·˜å®
            await page.goto('https://main.m.taobao.com/');
            await page.waitForTimeout(1000);
        }
        
        console.log('ğŸ¯ å‡†å¤‡è¾“å…¥éªŒè¯ç ...');
        // ç»§ç»­ä½ çš„éªŒè¯ç è¾“å…¥é€»è¾‘
    } else {
        console.log('ğŸš« æ— æ³•ç‚¹å‡»éªŒè¯ç æŒ‰é’®ï¼Œæµ‹è¯•ç»ˆæ­¢');
        // å¯ä»¥åœ¨è¿™é‡Œæˆªå›¾æˆ–ä¿å­˜çŠ¶æ€ä¾›åˆ†æ
        await page.screenshot({ path: 'verification-button-failed.png', fullPage: true });
    }

    

test('test', async ({ page, context }) => {

    await page.goto('https://main.m.taobao.com/?sprefer=sypc00');

    const iframeElement = page.frameLocator('iframe').first();


    await page.getByText('å¯»æ‰¾å®è´åº—é“ºæœç´¢').click();
    await page.locator('iframe').contentFrame().getByRole('textbox', { name: 'è¯·è¾“å…¥æ‰‹æœºå·' }).click();
    await page.locator('iframe').contentFrame().getByRole('textbox', { name: 'è¯·è¾“å…¥æ‰‹æœºå·' }).fill('16601112688');
    await page.locator('iframe').contentFrame().locator('label').filter({ hasText: /å·²é˜…è¯»å¹¶åŒæ„ä»¥ä¸‹åè®®/ }).click();
    
    const clicked = await clickVerificationCodeButton(page);
    if (!clicked) {
        // å¤„ç†å¤±è´¥æƒ…å†µ
    }
    console.log('\nâ³ ç­‰å¾…éªŒè¯ç ...');
    console.log('   è¯·æŸ¥çœ‹æ‰‹æœºçŸ­ä¿¡ï¼Œç„¶åè¾“å…¥éªŒè¯ç ');

    const verificationCode = await waitForVerificationCode();
    console.log(`âœ… è¾“å…¥çš„éªŒè¯ç : ${verificationCode}`);

    console.log('âŒ¨ï¸ æ­£åœ¨è¾“å…¥éªŒè¯ç ...');
    await iframeElement.locator('.view-input').first().click();
    await iframeElement.getByRole('textbox').fill(verificationCode);
    console.log('âœ… éªŒè¯ç å·²è¾“å…¥');
    // await page.locator('iframe').contentFrame().locator('.view-input').first().click();
    // await page.locator('iframe').contentFrame().getByRole('textbox').fill('3756');
    await page.getByText('æ˜Ÿæ˜Ÿäººç³»åˆ—æ³¡æ³¡ç›ç‰¹').click();
    await page.getByRole('link', { name: 'æ³¡æ³¡ç›ç‰¹æ˜Ÿæ˜Ÿäººè”åé©¬å…‹æ¯åˆ›æ„å¥¶æ²¹èƒ¶é™¶ç“·æ¯å­é€å¥³ç”Ÿé—ºèœœæ‰‹å·¥ç¤¼ç‰© Â¥ 191. 00 100+äººä»˜æ¬¾' }).click();
    await page.getByText('æ‰“å¼€æ·˜å®').click();
    await page.getByText('æ‰“å¼€æ·˜å®').click();
    await page.goto('https://main.m.taobao.com/search/index.html?spm=a215s.7406091.topbar.1.560c6770t1leU1&pageType=3&q=%E6%98%9F%E6%98%9F%E4%BA%BA%E7%B3%BB%E5%88%97%E6%B3%A1%E6%B3%A1%E7%8E%9B%E7%89%B9');
    await page.getByRole('textbox').click();
    await page.getByRole('textbox').click();
    await page.getByRole('textbox').fill('mkxk');
    await page.getByText('éº¦é¦¨å’–å•¡').click();
    await page.getByRole('link', { name: 'éº¦é¦¨maximéŸ©å›½åŸè£…è¿›å£æ‘©å¡ä¸‰åˆä¸€é€Ÿæº¶å’–å•¡1.' }).click();


    // await context.tracing.stop({
    //     path: '../trace.zip'
    // });
});